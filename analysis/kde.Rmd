---
title: "KDE"
author: "Shaine"
date: "`r Sys.Date()`"
output:
  bookdown::html_document2:
    number_sections: true
    toc: true
    fig_caption: true
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,fig.align = "center", fig.width = 5, fig.height = 3)
```

# Kernel Density Estimation

This is from @mariarizzo.

Let

```{r}
# Generate data
set.seed(123)
x_data <- rnorm(100, mean = 3, sd = 1)

# Parameters
x_point <- 3
h <- 0.5 # arbitrary
n <- length(x_data)
```


If a histogram with bin width $h$ is constructed from a sample $X_1, \dots, X_n$, then a density estimate for a point $x$ within the range of the data is 

$$
\hat{f}(x) = \frac{1}{2hn} \times k
$$

where $k$ is the number of sample points in the interval $\left( x-h, x+h\right)$. This estimator can be written as 

$$
\hat{f}(x) = \frac{1}{n} \sum^n_{i=1} \frac{1}{h}w \left( \frac{x - X_i}{h} \right) (\#eq:nde)
$$

where $w(t) =  \frac{1}{2} I(|t| < 1)$ is a weight function. The density estimator $\hat{f}(x)$ in \@ref(eq:nde) with $w(t) =  \frac{1}{2} I(|t| < 1)$ is called naive density estimator. This weight function has the property that $\int^{\infty}_{-\infty} K(t) dt = 1$, and $w(t) \geq 0$, so $w(t)$ is a probability density supported on the interval $[-1, 1]$.

```{r}
# weight function (naive)
naive_kernel <- function(t) {
  if (abs(t) < 1) return(0.5)
  else return(0)
}

# use the weight function to compute weight for each data point
# you check if t, not your raw point, is within the -1 to 1 window
t <- (x_point - x_data) / h
weights <- sapply(t, naive_kernel)


# naive density estimate for a point x
f_hat <- (1 / (n * h)) * sum(weights)
print(f_hat)
```



```{r}

# Points inside the window
in_window <- x_data[abs((x_point - x_data) / h) < 1]

# Plot
hist(x_data, breaks = 20, col = "gray90", border = "gray40",
     freq = FALSE, main = "Naive KDE Estimate at x = 3", xlab = "x")
abline(v = x_point, col = "blue", lty = 2, lwd = 2)              # Point of estimate
points(x_point, f_hat, col = "red", pch = 19, cex = 1.5)
text(x_point, f_hat, labels = round(f_hat, 3), pos = 3, col = "red")
```

```{r fig.height=4}

# Naive KDE function
naive_kde <- function(x, x_data, h) {
  n <- length(x_data)
  weights <- sapply(x_data, function(Xi) {
    t <- (x - Xi) / h
    naive_kernel(t)
  })
  return((1 / (n * h)) * sum(weights))
}

# KDE on a grid: take the KDEstimate for each point in the data
x_grid <- seq(min(x_data) - 1, max(x_data) + 1, length.out = 200)
kde_vals <- sapply(x_grid, naive_kde, x_data = x_data, h = h)

# Plot histogram and overlay KDE curves
hist(x_data, breaks = 20, col = "gray90", border = "gray40",
     freq = FALSE, main = "Naive KDE vs R::density()",
     xlab = "x", xlim = range(x_grid), ylim = c(0, max(kde_vals)*1.5))

# Overlay manual KDE
lines(x_grid, kde_vals, col = "blue", lwd = 2)

# Overlay R's built-in KDE with rectangular kernel
lines(density(x_data, bw = h, kernel = "rectangular"), col = "red", lwd = 2, lty = 2)

# Rug for data
rug(x_data, col = "gray40")

# Smaller legend
legend("topright", legend = c("Naive KDE (manual)", "R: density() with rectangular kernel"),
       col = c("blue", "red"), lty = c(1, 2), lwd = 2, cex = 0.5)

```


<div style="border-left: 4px solid #007ACC; padding: 1em; background: #f9f9f9;">
**Aside:**  
This function is 1 when $t$ is between $-1$ and $1$, and $0$ outside that range.

\begin{align*}
I(|t|<1) = 
\begin{cases}
  1 & \text{if} |t| < 1 \\
  0 & \text{otherwise}
\end{cases}
\end{align*}

This weight function is $\frac{1}{2}$ when $t$ is between $-1$ and $1$, and $0$ elsewhere.

$$
w(t) =  \frac{1}{2} I(|t| < 1)
$$

The below illustration of the kernel shows it is a valid PDF with area under the curve 1.

```{r echo = FALSE}
# Create a sequence of t values from -3 to 3
t <- seq(-3, 3, length.out = 500)

# Define the weight function w(t)
w <- ifelse(abs(t) < 1, 0.5, 0)

plot(t, w, type = "l", lwd = 1, col = "blue",
     xlab = "t", ylab = "w(t)",
     main = "Naive Kernel Function\n w(t) = 0.5 if |t| < 1, else 0")
abline(v = -1, col = "red", lty = 2)
abline(v = 1, col = "red", lty = 2)

```

</div>









# References
